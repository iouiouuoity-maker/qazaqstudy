const $ = (s) => document.querySelector(s);
const $$ = (s) => [...document.querySelectorAll(s)];

const STATE = {
  route: "home",     // home | lesson | assistant
  grade: "all",      // all | 7 | 8
  sound: true,
  lessonId: null,
  readTimer: null,
  wordIndex: 0,
  currentComic: "https://qazcomics.kz/kz/comics/5/2"
};

const COMICS = [
  { t: "QazComics", url: "https://qazcomics.kz/kz" },
  { t: "Ер Тарғын 1", url: "https://qazcomics.kz/kz/comics/5/1" },
  { t: "Ер Тарғын 2", url: "https://qazcomics.kz/kz/comics/5/2" },
  { t: "Ер Тарғын 3", url: "https://qazcomics.kz/kz/comics/5/3" },
  { t: "Ер Тарғын 4", url: "https://qazcomics.kz/kz/comics/5/4" }
];

const WORDS = [
  { kk: "тақырып", ru: "тема" },
  { kk: "негізгі ой", ru: "главная мысль" },
  { kk: "мәтін", ru: "текст" },
  { kk: "кейіпкер", ru: "персонаж" },
  { kk: "оқиға", ru: "событие" },
  { kk: "басы", ru: "начало" },
  { kk: "негізгі бөлім", ru: "основная часть" },
  { kk: "соңы", ru: "конец" }
];

const LESSONS = [
  {
    id: "7_main_idea",
    grade: "7",
    topic: "Мәтін",
    title: "Тақырып және негізгі ой",
    comic: { name: "Ер Тарғын • 2", url: "https://qazcomics.kz/kz/comics/5/2" },
    lines: [
      { kk: "Тақырып — мәтін не туралы екенін көрсетеді.", ru: "Тема показывает, о чём текст." },
      { kk: "Негізгі ой — автор не айтқысы келеді.", ru: "Главная мысль — что хотел сказать автор." },
      { kk: "Негізгі ойды бір сөйлеммен айтуға болады.", ru: "Главную мысль можно сказать одним предложением." }
    ],
    bank: ["Тақырып", "негізгі", "ойды", "автор", "айтады"],
    quiz: [
      { q: "Негізгі ой деген не?", opts: ["Автордың айтқысы келгені", "Кейіпкердің аты"], ans: "Автордың айтқысы келгені" },
      { q: "Тақырып нені көрсетеді?", opts: ["Не туралы", "Қай жылы"], ans: "Не туралы" }
    ],
    pickPool: [
      { q: "Қайсысы негізгі ой?", opts: ["Автордың айтқысы келгені", "Мәтіндегі ең ұзын сөйлем", "Кейіпкердің аты"], ans: "Автордың айтқысы келгені" },
      { q: "Қайсысы тақырыпқа жақын?", opts: ["Не туралы", "Қайда отырды", "Неше болды"], ans: "Не туралы" }
    ]
  },
  {
    id: "8_text_parts",
    grade: "8",
    topic: "Мәтін",
    title: "Мәтін бөліктері",
    comic: { name: "QazComics", url: "https://qazcomics.kz/kz" },
    lines: [
      { kk: "Мәтіннің басы — таныстыру.", ru: "Начало — знакомство." },
      { kk: "Негізгі бөлім — оқиға.", ru: "Основная часть — событие." },
      { kk: "Соңы — қорытынды.", ru: "Конец — итог." }
    ],
    bank: ["Мәтіннің", "басы", "негізгі", "бөлім", "соңы"],
    quiz: [
      { q: "Оқиға қай бөлікте?", opts: ["Негізгі бөлім", "Басы"], ans: "Негізгі бөлім" },
      { q: "Қорытынды қайда?", opts: ["Соңы", "Негізгі бөлім"], ans: "Соңы" }
    ],
    pickPool: [
      { q: "Қайсысы мәтіннің соңы?", opts: ["Қорытынды", "Таныстыру", "Оқиға"], ans: "Қорытынды" },
      { q: "Қайсысы негізгі бөлімге тән?", opts: ["Оқиға", "Тақырып", "Аты"], ans: "Оқиға" }
    ]
  }
];

/* ===== Speech ===== */
function canSpeak(){
  return ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window);
}
function speak(text){
  if (!STATE.sound) return;
  if (!canSpeak()) {
    $("#speechHint").textContent = "Бұл браузерде дыбыстау қолжетімсіз.";
    return;
  }
  $("#speechHint").textContent = "";
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95;
  window.speechSynthesis.speak(u);
}
function stopReading(){
  if (STATE.readTimer) { clearTimeout(STATE.readTimer); STATE.readTimer = null; }
  if (canSpeak()) window.speechSynthesis.cancel();
}

/* ===== Routing ===== */
function setRoute(route){
  STATE.route = route;
  $$(".page").forEach(p => p.classList.remove("is-on"));
  $("#page-" + route).classList.add("is-on");

  $$(".navbtn").forEach(b => b.classList.toggle("is-on", b.dataset.route === route));
}

function filteredLessons(){
  return (STATE.grade === "all") ? LESSONS : LESSONS.filter(x => x.grade === STATE.grade);
}

/* ===== Home render ===== */
function renderHome(){
  const grid = $("#topicGrid");
  grid.innerHTML = "";

  filteredLessons().forEach(l => {
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.innerHTML = `
      <div class="tMeta">
        <span class="chip">${l.grade}-сынып</span>
        <span class="chip">${l.topic}</span>
      </div>
      <div class="tTitle">${l.title}</div>
      <div class="tSub">Тапсырмалар • Сөйлем құрау • Комикс</div>
    `;
    tile.addEventListener("click", () => openLesson(l.id));
    grid.appendChild(tile);
  });
}

/* ===== Lesson render ===== */
function openLesson(id){
  const l = LESSONS.find(x => x.id === id);
  if (!l) return;

  stopReading();
  STATE.lessonId = id;
  STATE.currentComic = l.comic.url;

  $("#chipGrade").textContent = l.grade + "-сынып";
  $("#chipTopic").textContent = l.topic;
  $("#lessonTitle").textContent = l.title;

  // text
  const t = $("#lessonText");
  t.innerHTML = "";
  l.lines.forEach((ln, i) => {
    const row = document.createElement("div");
    row.className = "line";
    row.innerHTML = `
      <div class="badge">${i+1}</div>
      <div>
        <p class="k">${ln.kk}</p>
        <p class="r">${ln.ru}</p>
      </div>
    `;
    row.addEventListener("click", () => speak(ln.kk));
    t.appendChild(row);
  });

  // comic
  $("#comicName").textContent = l.comic.name;

  // comic list
  const cl = $("#comicList");
  cl.innerHTML = "";
  COMICS.forEach(c => {
    const r = document.createElement("div");
    r.className = "comRow";
    r.innerHTML = `<div class="comT">${c.t}</div><button class="btn ghost" type="button">Ашу</button>`;
    r.querySelector("button").addEventListener("click", () => window.open(c.url, "_blank", "noopener,noreferrer"));
    cl.appendChild(r);
  });

  // bank
  const bank = $("#bank");
  bank.innerHTML = "";
  l.bank.forEach(w => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "wbtn";
    b.textContent = w;
    b.addEventListener("click", () => addWord(w));
    bank.appendChild(b);
  });
  clearLine();

  renderQuiz(l.quiz);
  renderPick(l.pickPool);

  // words reset
  $("#wordSearch").value = "";
  STATE.wordIndex = 0;
  renderWords();

  setRoute("lesson");
}

function addWord(w){
  const out = $("#out");
  out.textContent = (out.textContent ? out.textContent + " " : "") + w;
  speak(w);
}
function clearLine(){ $("#out").textContent = ""; }

function renderQuiz(items){
  const quiz = $("#quiz");
  quiz.innerHTML = "";

  items.forEach(it => {
    const row = document.createElement("div");
    row.className = "qrow";
    row.innerHTML = `<div class="qt">${it.q}</div><div class="pills"></div>`;
    const pills = row.querySelector(".pills");

    it.opts.forEach(opt => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "pillbtn";
      b.textContent = opt;
      b.addEventListener("click", () => {
        if (opt === it.ans) { b.classList.add("ok"); speak("Жарайсың"); }
        else { speak(it.ans); }
      });
      pills.appendChild(b);
    });

    quiz.appendChild(row);
  });
}

function pickOne(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
function shuffle(a){ return [...a].sort(() => Math.random() - 0.5); }

function renderPick(pool){
  const pick = $("#pick");
  pick.innerHTML = "";
  const p = pickOne(pool);

  shuffle(p.opts).forEach(opt => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "abtn";
    b.textContent = opt;
    b.addEventListener("click", () => {
      if (opt === p.ans) { b.classList.add("ok"); speak("Жарайсың"); }
      else { speak(p.ans); }
    });
    pick.appendChild(b);
  });
}

/* ===== Words (Әрі қарай оқу — 100% жұмыс) ===== */
function getWordList(){
  const q = ($("#wordSearch").value || "").trim().toLowerCase();
  const list = q
    ? WORDS.filter(w => w.kk.toLowerCase().includes(q) || w.ru.toLowerCase().includes(q))
    : WORDS;
  return list;
}

function renderWords(){
  const list = getWordList();
  const box = $("#words");
  box.innerHTML = "";

  list.forEach((w, i) => {
    const row = document.createElement("div");
    row.className = "wi";
    row.dataset.i = String(i);
    row.innerHTML = `
      <div>
        <div class="wkk">${w.kk}</div>
        <div class="wru">${w.ru}</div>
      </div>
      <button class="wiBtn" type="button">Оқу</button>
    `;
    row.querySelector("button").addEventListener("click", () => speak(w.kk));
    box.appendChild(row);
  });
}

function highlightWord(i){
  const rows = $$("#words .wi");
  rows.forEach(r => r.style.outline = "none");
  const target = rows[i];
  if (!target) return;
  target.style.outline = "3px solid rgba(59,130,246,.55)";
  target.style.outlineOffset = "2px";
  target.scrollIntoView({ block:"nearest", behavior:"smooth" });
}

function nextWordRead(){
  const list = getWordList();
  if (!list.length) return;

  if (STATE.wordIndex >= list.length) STATE.wordIndex = 0;
  const w = list[STATE.wordIndex];

  highlightWord(STATE.wordIndex);
  speak(w.kk);

  STATE.wordIndex += 1;
}

/* ===== UI hooks ===== */
function hookUI(){
  // route buttons
  $$(".navbtn").forEach(b => b.addEventListener("click", () => setRoute(b.dataset.route)));

  // home click
  $("#goHome").addEventListener("click", () => { setRoute("home"); });
  $("#goHome").addEventListener("keydown", (e) => { if (e.key === "Enter") setRoute("home"); });

  // grade
  $$("[data-grade]").forEach(b => b.addEventListener("click", () => {
    STATE.grade = b.dataset.grade;
    $$("[data-grade]").forEach(x => x.classList.toggle("is-on", x.dataset.grade === STATE.grade));
    renderHome();
    setRoute("home");
  }));

  // back
  $("#backHome").addEventListener("click", () => { setRoute("home"); stopReading(); });

  // contrast/font/sound
  $("#t-contrast").addEventListener("click", () => {
    const on = document.body.classList.toggle("contrast");
    $("#t-contrast").setAttribute("aria-pressed", String(on));
  });
  $("#t-font").addEventListener("click", () => {
    const on = document.body.classList.toggle("big");
    $("#t-font").setAttribute("aria-pressed", String(on));
  });
  $("#t-sound").addEventListener("click", () => {
    STATE.sound = !STATE.sound;
    $("#t-sound").classList.toggle("is-on", STATE.sound);
    $("#t-sound").setAttribute("aria-pressed", String(STATE.sound));
    if (!STATE.sound) stopReading();
  });

  // lesson nav
  $("#prevLesson").addEventListener("click", () => {
    const list = filteredLessons();
    const idx = Math.max(0, list.findIndex(x => x.id === STATE.lessonId));
    const prev = list[(idx - 1 + list.length) % list.length];
    openLesson(prev.id);
  });
  $("#nextLesson").addEventListener("click", () => {
    const list = filteredLessons();
    const idx = Math.max(0, list.findIndex(x => x.id === STATE.lessonId));
    const next = list[(idx + 1) % list.length];
    openLesson(next.id);
  });

  // comic
  $("#openComic").addEventListener("click", () => window.open(STATE.currentComic, "_blank", "noopener,noreferrer"));

  // read all text
  $("#readAllText").addEventListener("click", () => {
    stopReading();
    const l = LESSONS.find(x => x.id === STATE.lessonId);
    if (!l) return;

    let i = 0;
    const seq = () => {
      if (!STATE.sound) return;
      if (i >= l.lines.length) return;
      speak(l.lines[i].kk);
      i += 1;
      STATE.readTimer = setTimeout(seq, 1200);
    };
    seq();
  });

  $("#stopRead").addEventListener("click", stopReading);

  // pick regen
  $("#regenPick").addEventListener("click", () => {
    const l = LESSONS.find(x => x.id === STATE.lessonId);
    if (!l) return;
    renderPick(l.pickPool);
  });

  // sentence
  $("#sayLine").addEventListener("click", () => speak($("#out").textContent || " "));
  $("#clearLine").addEventListener("click", clearLine);

  // words
  $("#wordSearch").addEventListener("input", () => { STATE.wordIndex = 0; renderWords(); });
  $("#wordNext").addEventListener("click", nextWordRead);
}

function start(){
  hookUI();
  // default state
  STATE.grade = "all";
  renderHome();
  setRoute("home");
}

start();
