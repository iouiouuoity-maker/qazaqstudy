const $ = (s) => document.querySelector(s);
const $$ = (s) => [...document.querySelectorAll(s)];

const STATE = {
  grade: "all",
  sound: true,
  lessonId: null,
  readTimer: null,
  currentComic: "https://qazcomics.kz/kz/comics/5/2",
  wordIndex: 0,
};

const COMICS = [
  { t: "QazComics", url: "https://qazcomics.kz/kz" },
  { t: "Ер Тарғын 1", url: "https://qazcomics.kz/kz/comics/5/1" },
  { t: "Ер Тарғын 2", url: "https://qazcomics.kz/kz/comics/5/2" },
  { t: "Ер Тарғын 3", url: "https://qazcomics.kz/kz/comics/5/3" },
  { t: "Ер Тарғын 4", url: "https://qazcomics.kz/kz/comics/5/4" },
];

const WORDS = [
  { kk: "тақырып", ru: "тема" },
  { kk: "негізгі ой", ru: "главная мысль" },
  { kk: "мәтін", ru: "текст" },
  { kk: "кейіпкер", ru: "персонаж" },
  { kk: "оқиға", ru: "событие" },
  { kk: "басы", ru: "начало" },
  { kk: "негізгі бөлім", ru: "основная часть" },
  { kk: "соңы", ru: "конец" },
];

const LESSONS = [
  {
    id: "7_main_idea",
    grade: "7",
    topic: "Мәтін",
    title: "Тақырып және негізгі ой",
    comic: { name: "Ер Тарғын • 2", url: "https://qazcomics.kz/kz/comics/5/2" },
    lines: [
      { kk: "Тақырып — мәтін не туралы екенін көрсетеді.", ru: "Тема показывает, о чём текст." },
      { kk: "Негізгі ой — автор не айтқысы келеді.", ru: "Главная мысль — что хотел сказать автор." },
      { kk: "Негізгі ойды бір сөйлеммен айтуға болады.", ru: "Главную мысль можно сказать одним предложением." },
    ],
    bank: ["Тақырып", "негізгі", "ойды", "автор", "айтады"],
    quiz: [
      { q: "Негізгі ой деген не?", opts: ["Автордың айтқысы келгені", "Кейіпкердің аты"], ans: "Автордың айтқысы келгені" },
      { q: "Тақырып нені көрсетеді?", opts: ["Не туралы", "Қай жылы"], ans: "Не туралы" },
    ],
    pickPool: [
      { q: "Қайсысы негізгі ой?", opts: ["Автордың айтқысы келгені", "Кейіпкердің аты", "Ұзын сөйлем"], ans: "Автордың айтқысы келгені" },
    ],
  },
  {
    id: "8_text_parts",
    grade: "8",
    topic: "Мәтін",
    title: "Мәтін бөліктері",
    comic: { name: "QazComics", url: "https://qazcomics.kz/kz" },
    lines: [
      { kk: "Мәтіннің басы — таныстыру.", ru: "Начало — знакомство." },
      { kk: "Негізгі бөлім — оқиға.", ru: "Основная часть — событие." },
      { kk: "Соңы — қорытынды.", ru: "Конец — итог." },
    ],
    bank: ["Мәтіннің", "басы", "негізгі", "бөлім", "соңы"],
    quiz: [
      { q: "Оқиға қай бөлікте?", opts: ["Негізгі бөлім", "Басы"], ans: "Негізгі бөлім" },
      { q: "Қорытынды қайда?", opts: ["Соңы", "Басы"], ans: "Соңы" },
    ],
    pickPool: [
      { q: "Қайсысы соңы?", opts: ["Қорытынды", "Оқиға", "Таныстыру"], ans: "Қорытынды" },
    ],
  },
];

// ===== Speech
function canSpeak(){
  return "speechSynthesis" in window && "SpeechSynthesisUtterance" in window;
}
function stopReading(){
  if (STATE.readTimer) { clearTimeout(STATE.readTimer); STATE.readTimer = null; }
  if (canSpeak()) window.speechSynthesis.cancel();
}
function speak(text){
  if (!STATE.sound) return;
  if (!canSpeak()) {
    const hint = $("#speechHint");
    if (hint) hint.textContent = "Озвучка недоступна в этом браузере.";
    return;
  }
  const hint = $("#speechHint");
  if (hint) hint.textContent = "";
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95;
  window.speechSynthesis.speak(u);
}

// ===== Navigation (pages)
function setActiveNav(hash){
  $("#navHome")?.classList.toggle("is-on", hash === "#home");
  $("#navAssistant")?.classList.toggle("is-on", hash === "#assistant");
}
function show(id){
  $("#page-home").hidden = true;
  $("#page-lesson").hidden = true;
  $("#page-assistant").hidden = true;
  $(id).hidden = false;
}

// ===== Data helpers
function filteredLessons(){
  return STATE.grade === "all" ? LESSONS : LESSONS.filter(x => x.grade === STATE.grade);
}
function findLesson(id){
  return LESSONS.find(x => x.id === id) || LESSONS[0];
}

// ===== Render HOME
function renderHome(){
  const grid = $("#topicGrid");
  grid.innerHTML = "";
  filteredLessons().forEach(l => {
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.innerHTML = `
      <div class="tMeta">
        <span class="chip">${l.grade}-сынып</span>
        <span class="chip">${l.topic}</span>
      </div>
      <div class="tTitle">${l.title}</div>
      <div class="tSub">Комикс • Түсіну • Сөйлем құра</div>
    `;
    tile.addEventListener("click", () => {
      location.hash = `#lesson-${l.id}`;
    });
    grid.appendChild(tile);
  });
}

// ===== Lesson render
function renderComics(){
  const box = $("#comicList");
  box.innerHTML = "";
  COMICS.forEach(c => {
    const r = document.createElement("div");
    r.className = "comRow";
    r.innerHTML = `<div class="comT">${c.t}</div><button class="btn ghost" type="button">Открыть</button>`;
    r.querySelector("button").addEventListener("click", () => window.open(c.url, "_blank", "noopener,noreferrer"));
    box.appendChild(r);
  });
}

function renderQuiz(items){
  const quiz = $("#quiz");
  quiz.innerHTML = "";
  items.forEach(it => {
    const row = document.createElement("div");
    row.className = "qrow";
    row.innerHTML = `<div class="qt">${it.q}</div><div class="pills"></div>`;
    const pills = row.querySelector(".pills");

    it.opts.forEach(opt => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "pillbtn";
      b.textContent = opt;
      b.addEventListener("click", () => {
        if (opt === it.ans) { b.classList.add("ok"); speak("Жарайсың"); }
        else speak(it.ans);
      });
      pills.appendChild(b);
    });

    quiz.appendChild(row);
  });
}

function renderPick(pool){
  const pick = $("#pick");
  pick.innerHTML = "";
  const p = pool[Math.floor(Math.random() * pool.length)];
  [...p.opts].sort(() => Math.random() - 0.5).forEach(opt => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "abtn";
    b.textContent = opt;
    b.addEventListener("click", () => {
      if (opt === p.ans) { b.classList.add("ok"); speak("Жарайсың"); }
      else speak(p.ans);
    });
    pick.appendChild(b);
  });
}

function renderWords(){
  const q = ($("#wordSearch").value || "").trim().toLowerCase();
  const list = q
    ? WORDS.filter(w => w.kk.toLowerCase().includes(q) || w.ru.toLowerCase().includes(q))
    : WORDS;

  const box = $("#words");
  box.innerHTML = "";
  list.forEach((w, i) => {
    const row = document.createElement("div");
    row.className = "wi";
    row.dataset.i = String(i);
    row.innerHTML = `
      <div>
        <div class="wkk">${w.kk}</div>
        <div class="wru">${w.ru}</div>
      </div>
      <button class="wiBtn" type="button">Оқу</button>
    `;
    row.querySelector("button").addEventListener("click", () => speak(w.kk));
    box.appendChild(row);
  });

  return list;
}

function highlightWord(i){
  const rows = $$("#words .wi");
  rows.forEach(r => (r.style.outline = "none"));
  const t = rows[i];
  if (!t) return;
  t.style.outline = "3px solid rgba(59,130,246,.55)";
  t.style.outlineOffset = "2px";
  t.scrollIntoView({ block:"nearest", behavior:"smooth" });
}

function nextWord(){
  const list = renderWords();
  if (!list.length) return;
  if (STATE.wordIndex >= list.length) STATE.wordIndex = 0;
  highlightWord(STATE.wordIndex);
  speak(list[STATE.wordIndex].kk);
  STATE.wordIndex += 1;
}

function setLesson(id){
  const l = findLesson(id);
  STATE.lessonId = l.id;
  STATE.currentComic = l.comic.url;
  STATE.wordIndex = 0;
  stopReading();

  $("#chipGrade").textContent = l.grade + "-сынып";
  $("#chipTopic").textContent = l.topic;
  $("#lessonTitle").textContent = l.title;
  $("#comicName").textContent = l.comic.name;

  // text
  const t = $("#lessonText");
  t.innerHTML = "";
  l.lines.forEach((ln, i) => {
    const row = document.createElement("div");
    row.className = "line";
    row.innerHTML = `
      <div class="badge">${i+1}</div>
      <div>
        <p class="k">${ln.kk}</p>
        <p class="r">${ln.ru}</p>
      </div>
    `;
    row.addEventListener("click", () => speak(ln.kk));
    t.appendChild(row);
  });

  // bank
  const bank = $("#bank");
  bank.innerHTML = "";
  l.bank.forEach(w => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "wbtn";
    b.textContent = w;
    b.addEventListener("click", () => {
      const out = $("#out");
      out.textContent = (out.textContent ? out.textContent + " " : "") + w;
      speak(w);
    });
    bank.appendChild(b);
  });

  $("#out").textContent = "";
  $("#wordSearch").value = "";

  renderComics();
  renderQuiz(l.quiz);
  renderPick(l.pickPool);
  renderWords();
}

// ===== Router
function route(){
  const h = location.hash || "#home";
  setActiveNav(h);

  if (h === "#home") {
    show("#page-home");
    return;
  }
  if (h === "#assistant") {
    show("#page-assistant");
    return;
  }
  if (h.startsWith("#lesson-")) {
    show("#page-lesson");
    setLesson(h.replace("#lesson-", ""));
    return;
  }
  // fallback
  location.hash = "#home";
}

// ===== Hooks
function hook(){
  // grade filter
  $$("[data-grade]").forEach(b => b.addEventListener("click", () => {
    STATE.grade = b.dataset.grade;
    $$("[data-grade]").forEach(x => x.classList.toggle("is-on", x.dataset.grade === STATE.grade));
    renderHome();
  }));

  // toggles
  $("#btnContrast").addEventListener("click", () => document.body.classList.toggle("contrast"));
  $("#btnFont").addEventListener("click", () => document.body.classList.toggle("big"));
  $("#btnSound").addEventListener("click", () => {
    STATE.sound = !STATE.sound;
    $("#btnSound").classList.toggle("is-on", STATE.sound);
    if (!STATE.sound) stopReading();
  });

  // lesson buttons
  $("#btnOpenComic").addEventListener("click", () => window.open(STATE.currentComic, "_blank", "noopener,noreferrer"));
  $("#btnReadAll").addEventListener("click", () => {
    stopReading();
    const l = findLesson(STATE.lessonId);
    let i = 0;
    const seq = () => {
      if (!STATE.sound) return;
      if (i >= l.lines.length) return;
      speak(l.lines[i].kk);
      i += 1;
      STATE.readTimer = setTimeout(seq, 1200);
    };
    seq();
  });
  $("#btnStop").addEventListener("click", stopReading);

  $("#btnClearLine").addEventListener("click", () => $("#out").textContent = "");
  $("#btnSayLine").addEventListener("click", () => speak($("#out").textContent || " "));

  $("#btnPickNew").addEventListener("click", () => {
    const l = findLesson(STATE.lessonId);
    renderPick(l.pickPool);
  });

  $("#wordSearch").addEventListener("input", () => { STATE.wordIndex = 0; renderWords(); });
  $("#btnWordNext").addEventListener("click", nextWord);

  $("#btnPrev").addEventListener("click", () => {
    const list = filteredLessons();
    const idx = Math.max(0, list.findIndex(x => x.id === STATE.lessonId));
    const prev = list[(idx - 1 + list.length) % list.length];
    location.hash = `#lesson-${prev.id}`;
  });
  $("#btnNext").addEventListener("click", () => {
    const list = filteredLessons();
    const idx = Math.max(0, list.findIndex(x => x.id === STATE.lessonId));
    const next = list[(idx + 1) % list.length];
    location.hash = `#lesson-${next.id}`;
  });

  window.addEventListener("hashchange", route);
}

function start(){
  renderHome();
  hook();
  route();
}

start();
